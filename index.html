<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <script src="plot.js"></script>
    <script src="layers.js"></script>
    <script src="util.js"></script>
    <link rel="stylesheet" href="style.css" />

    <title>D3 Sf</title>
  </head>
  <body>
    <!-- <svg width="100%" height="1200px"></svg> -->
    <script>
      d3.queue()
        .defer(d3.json, "data/euSfGeo.json")
        .defer(d3.json, "data/PoliceDistricts.json")
        .defer(d3.csv, "data/2018pdi.csv")
        .await((err, mapData, pdData, dotData) => {
          const sfMap = initMap();
          let scaleData = util.pivot.incidentByDistrict(dotData);

          drawMap(err, mapData, sfMap.path);
          drawPDMap(err, pdData, sfMap.path, scaleData);

          var stepper = setInterval(
            (function() {
              var date = new Date("1-1-2018"),
                endDate = new Date("5-30-2018");
              return function() {
                year = timeline_step(
                  new Date(date.setDate(date.getDate() + 1)),
                  endDate
                );
              };
            })(),
            50
          );

          function timeline_step(date, endDate) {
            
            requestAnimationFrame(function() {
              d3.select("h1#currentTime").html(util.formatDate(date));
              plotDots(err, dotData, sfMap.projection, util.formatDate(date));
            });
            if (date >= endDate) {
              clearInterval(stepper);
            }

            return endDate;
          }
        });
    </script>
  </body>
</html>
